name: Release (Tag)

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_macos:
        description: "Build macOS artifacts"
        required: true
        default: true
        type: boolean
      build_windows:
        description: "Build Windows artifact"
        required: true
        default: false
        type: boolean
      run_secret_scan:
        description: "Run TruffleHog scans"
        required: true
        default: false
        type: boolean

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-release:
    name: Create GitHub release
    if: ${{ startsWith(github.ref, 'refs/tags/v') }}
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Secret scan (filesystem)
        if: ${{ github.event_name == 'push' || inputs.run_secret_scan }}
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm \
            -v "$PWD:/work" \
            ghcr.io/trufflesecurity/trufflehog:latest \
            filesystem --no-verification --fail --exclude-paths=/work/.trufflehog-exclude.txt /work

      - name: Secret scan (git history)
        if: ${{ github.event_name == 'push' || inputs.run_secret_scan }}
        shell: bash
        run: |
          set -euo pipefail
          docker run --rm \
            -v "$PWD:/work" \
            -w /work \
            ghcr.io/trufflesecurity/trufflehog:latest \
            git --no-verification --fail file:///work

      - name: Create release if missing
        shell: bash
        run: |
          set -euo pipefail
          if gh release view "${GITHUB_REF_NAME}" >/dev/null 2>&1; then
            exit 0
          fi

          if [[ "${GITHUB_REF_NAME}" == *"-test"* ]]; then
            gh release create "${GITHUB_REF_NAME}" \
              --title "File Architect ${GITHUB_REF_NAME}" \
              --notes "" \
              --draft \
              --prerelease
          else
            gh release create "${GITHUB_REF_NAME}" \
              --title "File Architect ${GITHUB_REF_NAME}" \
              --notes "" \
              --draft
          fi

  build-macos:
    name: Build macOS (signed, ${{ matrix.target_key }})
    if: >-
      ${{
        always() &&
        (
          (startsWith(github.ref, 'refs/tags/v') && needs.create-release.result == 'success') ||
          (github.event_name == 'workflow_dispatch' && inputs.build_macos)
        )
      }}
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - target_key: darwin-aarch64
            rust_target: aarch64-apple-darwin
            runner: macos-14
          - target_key: darwin-x86_64
            rust_target: x86_64-apple-darwin
            runner: macos-15-intel
    runs-on: ${{ matrix.runner }}
    env:
      VITE_APP_ENV: production
      VITE_APP_URL: https://filearchitect.com
      VITE_API_URL: https://filearchitect.com/api/v1
      VITE_MAX_LINES_FREE_VERSION: 5
      VITE_LICENSE_CHECK_GRACE_PERIOD_HOURS: 24
      VITE_DEEPINFRA_API_KEY: ${{ secrets.VITE_DEEPINFRA_API_KEY || secrets.DEEPINFRA_API_KEY }}
      APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
      APPLE_ID: ${{ secrets.APPLE_ID }}
      APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
      APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Validate signing configuration
        shell: bash
        env:
          APPLE_CERTIFICATE_RAW: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD_RAW: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY_RAW: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID_RAW: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD_RAW: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID_RAW: ${{ secrets.APPLE_TEAM_ID }}
          TAURI_SIGNING_PRIVATE_KEY_RAW: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD_RAW: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          TAURI_PRIVATE_KEY_RAW: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_PRIVATE_KEY_PASSWORD_RAW: ${{ secrets.TAURI_PRIVATE_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          TEAM_ID="$(printf '%s' "${APPLE_TEAM_ID_RAW:-}" | tr -d '\r\n[:space:]\"')"
          TAURI_KEY_RAW="${TAURI_SIGNING_PRIVATE_KEY_RAW:-${TAURI_PRIVATE_KEY_RAW:-}}"
          TAURI_KEY_PASSWORD_RAW="${TAURI_SIGNING_PRIVATE_KEY_PASSWORD_RAW:-${TAURI_PRIVATE_KEY_PASSWORD_RAW:-}}"
          missing=()
          for key in APPLE_CERTIFICATE_RAW APPLE_CERTIFICATE_PASSWORD_RAW APPLE_SIGNING_IDENTITY_RAW APPLE_ID_RAW APPLE_PASSWORD_RAW; do
            if [[ -z "${!key:-}" ]]; then
              missing+=("$key")
            fi
          done
          if [[ "${#TEAM_ID}" -lt 3 ]]; then
            missing+=("APPLE_TEAM_ID_RAW")
          fi
          if [[ -z "${TAURI_KEY_RAW:-}" ]]; then
            missing+=("TAURI_SIGNING_PRIVATE_KEY_RAW/TAURI_PRIVATE_KEY_RAW")
          fi
          if [[ -z "${TAURI_KEY_PASSWORD_RAW:-}" ]]; then
            missing+=("TAURI_SIGNING_PRIVATE_KEY_PASSWORD_RAW/TAURI_PRIVATE_KEY_PASSWORD_RAW")
          fi
          if (( ${#missing[@]} > 0 )); then
            echo "Missing/invalid signing secrets: ${missing[*]}"
            exit 1
          fi

          # Fast preflight: validate cert/password and updater key format before heavy build steps.
          CERT_PATH="$RUNNER_TEMP/preflight-signing-cert.p12"
          printf '%s' "$APPLE_CERTIFICATE_RAW" | tr -d '\r\n' | base64 -d > "$CERT_PATH"
          openssl pkcs12 -in "$CERT_PATH" -nokeys -passin "pass:${APPLE_CERTIFICATE_PASSWORD_RAW}" >/dev/null

          KEY="$(printf '%s' "${TAURI_KEY_RAW}" | tr -d '\r')"
          if [[ "${KEY}" == *"untrusted comment:"* ]]; then
            KEY_B64="$(printf '%s' "${KEY}" | base64 | tr -d '\r\n')"
          else
            KEY_B64="$(printf '%s' "${KEY}" | tr -d '\r\n')"
          fi
          DECODED_KEY="$(printf '%s' "${KEY_B64}" | base64 -d 2>/dev/null || true)"
          if [[ "${DECODED_KEY}" != *"untrusted comment:"* ]]; then
            echo "Invalid Tauri updater key format. Secret must be raw key text or base64 key text."
            exit 1
          fi
          if [[ -z "$(printf '%s' "${TAURI_KEY_PASSWORD_RAW}" | tr -d '\r')" ]]; then
            echo "Invalid Tauri updater key password."
            exit 1
          fi

          echo "Signing secrets detected and preflight-validated."

      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate app version matches tag
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ -z "${VERSION}" ]]; then
            echo "Unable to derive version from tag: ${GITHUB_REF_NAME}"
            exit 1
          fi

          node scripts/version-check.mjs "$VERSION"

      - name: Normalize Apple team ID
        shell: bash
        env:
          APPLE_TEAM_ID_RAW: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          set -euo pipefail
          trim() {
            printf '%s' "$1" \
              | tr -d '\r' \
              | sed -E 's/^[[:space:]]+//; s/[[:space:]]+$//; s/^"//; s/"$//'
          }

          TEAM_ID="$(trim "${APPLE_TEAM_ID_RAW:-}")"
          if [[ ${#TEAM_ID} -lt 3 ]]; then
            FALLBACK_TEAM_ID="$(sed -nE 's/.*"providerShortName":[[:space:]]*"([^"]+)".*/\1/p' src-tauri/tauri.conf.json | head -n1)"
            TEAM_ID="$(trim "${FALLBACK_TEAM_ID:-}")"
          fi

          if [[ ${#TEAM_ID} -lt 3 ]]; then
            echo "APPLE_TEAM_ID is invalid after normalization. Set APPLE_TEAM_ID repo secret to your Apple Team ID."
            exit 1
          fi

          echo "::add-mask::$TEAM_ID"
          echo "APPLE_TEAM_ID=$TEAM_ID" >> "$GITHUB_ENV"
          echo "Normalized APPLE_TEAM_ID length: ${#TEAM_ID}"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.rust_target }}

      - name: Normalize Tauri updater signing key
        shell: bash
        env:
          TAURI_SIGNING_PRIVATE_KEY_RAW: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD_RAW: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          TAURI_PRIVATE_KEY_RAW: ${{ secrets.TAURI_PRIVATE_KEY }}
          TAURI_PRIVATE_KEY_PASSWORD_RAW: ${{ secrets.TAURI_PRIVATE_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          KEY_RAW="${TAURI_SIGNING_PRIVATE_KEY_RAW:-${TAURI_PRIVATE_KEY_RAW:-}}"
          KEY_PASSWORD_RAW="${TAURI_SIGNING_PRIVATE_KEY_PASSWORD_RAW:-${TAURI_PRIVATE_KEY_PASSWORD_RAW:-}}"
          KEY="$(printf '%s' "${KEY_RAW}" | tr -d '\r')"
          KEY_PASSWORD="$(printf '%s' "${KEY_PASSWORD_RAW}" | tr -d '\r')"

          if [[ -z "${KEY}" || -z "${KEY_PASSWORD}" ]]; then
            echo "Missing TAURI updater signing key/password after normalization."
            exit 1
          fi

          # Tauri expects updater private key as base64-encoded content.
          if [[ "${KEY}" == *"untrusted comment:"* ]]; then
            KEY_B64="$(printf '%s' "${KEY}" | base64 | tr -d '\r\n')"
          else
            KEY_B64="$(printf '%s' "${KEY}" | tr -d '\r\n')"
          fi

          DECODED_KEY="$(printf '%s' "${KEY_B64}" | base64 -d 2>/dev/null || true)"
          if [[ "${DECODED_KEY}" != *"untrusted comment:"* ]]; then
            echo "TAURI updater private key is invalid (expected raw key content or base64 key content)."
            exit 1
          fi

          echo "::add-mask::$KEY_B64"
          echo "::add-mask::$KEY_PASSWORD"
          echo "TAURI_SIGNING_PRIVATE_KEY<<EOF" >> "$GITHUB_ENV"
          echo "$KEY_B64" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"
          echo "TAURI_PRIVATE_KEY<<EOF" >> "$GITHUB_ENV"
          echo "$KEY_B64" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"
          echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD=$KEY_PASSWORD" >> "$GITHUB_ENV"
          echo "TAURI_PRIVATE_KEY_PASSWORD=$KEY_PASSWORD" >> "$GITHUB_ENV"
          echo "Normalized TAURI updater key length: ${#KEY_B64}"

      - name: Import Apple certificate into keychain
        shell: bash
        env:
          APPLE_CERTIFICATE_RAW: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD_RAW: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          set -euo pipefail
          CERT_PATH="$RUNNER_TEMP/signing-cert.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -base64 24 | tr -d '\n')"

          echo "APPLE_CERTIFICATE_RAW length: ${#APPLE_CERTIFICATE_RAW}"
          printf '%s' "$APPLE_CERTIFICATE_RAW" | tr -d '\r\n' | base64 -d > "$CERT_PATH"
          echo "Decoded cert bytes: $(wc -c < "$CERT_PATH")"
          shasum -a 256 "$CERT_PATH"
          openssl pkcs12 -in "$CERT_PATH" -nokeys -passin "pass:${APPLE_CERTIFICATE_PASSWORD_RAW}" >/dev/null

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -f pkcs12 -P "$APPLE_CERTIFICATE_PASSWORD_RAW" -A -T /usr/bin/codesign -T /usr/bin/security
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate AI API key env
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${VITE_DEEPINFRA_API_KEY:-}" ]]; then
            echo "Missing VITE_DEEPINFRA_API_KEY (or DEEPINFRA_API_KEY) repository secret."
            exit 1
          fi

      - name: Build app
        shell: bash
        run: |
          set -euo pipefail
          # Use the certificate already imported in keychain.
          unset APPLE_CERTIFICATE
          unset APPLE_CERTIFICATE_PASSWORD
          pnpm tauri build --config src-tauri/tauri.production.conf.json --target "${{ matrix.rust_target }}"

      - name: Upload release assets (macOS binaries)
        if: ${{ startsWith(github.ref, 'refs/tags/v') }}
        shell: bash
        run: |
          set -euo pipefail
          TARGET_DIR="src-tauri/target/${{ matrix.rust_target }}/release/bundle"
          APP_TAR="$(ls "${TARGET_DIR}/macos/"*.app.tar.gz | head -n1)"
          APP_SIG="${APP_TAR}.sig"
          DMG_FILE="$(ls "${TARGET_DIR}/dmg/"*.dmg | head -n1)"
          VERSION="${GITHUB_REF_NAME#v}"

          RENAMED_APP_TAR="filearchitect_${VERSION}_${{ matrix.target_key }}.app.tar.gz"
          RENAMED_APP_SIG="${RENAMED_APP_TAR}.sig"
          RENAMED_DMG="filearchitect_${VERSION}_${{ matrix.target_key }}.dmg"

          cp "$APP_TAR" "$RENAMED_APP_TAR"
          cp "$APP_SIG" "$RENAMED_APP_SIG"
          cp "$DMG_FILE" "$RENAMED_DMG"

          gh release upload "${GITHUB_REF_NAME}" "$RENAMED_APP_TAR" "$RENAMED_APP_SIG" "$RENAMED_DMG" --clobber

      - name: Upload dry-run artifacts (macOS binaries)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.target_key }}-${{ github.run_number }}
          path: |
            src-tauri/target/${{ matrix.rust_target }}/release/bundle/macos/*.app.tar.gz
            src-tauri/target/${{ matrix.rust_target }}/release/bundle/macos/*.app.tar.gz.sig
            src-tauri/target/${{ matrix.rust_target }}/release/bundle/dmg/*.dmg
          if-no-files-found: error

  build-macos-manifest:
    name: Build macOS updater manifest
    if: ${{ startsWith(github.ref, 'refs/tags/v') }}
    needs:
      - create-release
      - build-macos
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Generate updater manifest (latest.json)
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          PUB_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          RELEASE_JSON="$(gh release view "${GITHUB_REF_NAME}" --json assets)"

          find_asset_id() {
            local name="$1"
            printf '%s' "$RELEASE_JSON" | jq -r --arg name "$name" '.assets[] | select(.name == $name) | .id' | head -n1
          }

          read_sig_asset() {
            local id="$1"
            gh api \
              -H "Accept: application/octet-stream" \
              "repos/${GITHUB_REPOSITORY}/releases/assets/${id}"
          }

          ARM_APP="filearchitect_${VERSION}_darwin-aarch64.app.tar.gz"
          ARM_SIG_ASSET="${ARM_APP}.sig"
          X64_APP="filearchitect_${VERSION}_darwin-x86_64.app.tar.gz"
          X64_SIG_ASSET="${X64_APP}.sig"

          ARM_SIG_ID="$(find_asset_id "$ARM_SIG_ASSET")"
          X64_SIG_ID="$(find_asset_id "$X64_SIG_ASSET")"

          if [[ -z "${ARM_SIG_ID}" || -z "${X64_SIG_ID}" ]]; then
            echo "Missing macOS updater signature assets for one or both architectures."
            echo "Expected: ${ARM_SIG_ASSET} and ${X64_SIG_ASSET}"
            exit 1
          fi

          ARM_SIG_CONTENT="$(read_sig_asset "${ARM_SIG_ID}")"
          X64_SIG_CONTENT="$(read_sig_asset "${X64_SIG_ID}")"

          ARM_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${GITHUB_REF_NAME}/${ARM_APP}"
          X64_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${GITHUB_REF_NAME}/${X64_APP}"

          jq -n \
            --arg version "$VERSION" \
            --arg notes "" \
            --arg pub_date "$PUB_DATE" \
            --arg arm_signature "$ARM_SIG_CONTENT" \
            --arg arm_url "$ARM_URL" \
            --arg x64_signature "$X64_SIG_CONTENT" \
            --arg x64_url "$X64_URL" \
            '{
              version: $version,
              notes: $notes,
              pub_date: $pub_date,
              platforms: {
                "darwin-aarch64": {
                  signature: $arm_signature,
                  url: $arm_url
                },
                "darwin-x86_64": {
                  signature: $x64_signature,
                  url: $x64_url
                }
              }
            }' > latest.json

          cat latest.json

      - name: Upload release assets (macOS manifest)
        shell: bash
        run: |
          set -euo pipefail
          gh release upload "${GITHUB_REF_NAME}" latest.json --clobber

  build-windows:
    name: Build Windows
    if: ${{ (github.event_name == 'push' && !contains(github.ref_name, '-test')) || (github.event_name == 'workflow_dispatch' && inputs.build_windows) }}
    needs: create-release
    runs-on: windows-latest
    env:
      VITE_APP_ENV: production
      VITE_APP_URL: https://filearchitect.com
      VITE_API_URL: https://filearchitect.com/api/v1
      VITE_MAX_LINES_FREE_VERSION: 5
      VITE_LICENSE_CHECK_GRACE_PERIOD_HOURS: 24
      VITE_DEEPINFRA_API_KEY: ${{ secrets.VITE_DEEPINFRA_API_KEY || secrets.DEEPINFRA_API_KEY }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate app version matches tag
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ -z "${VERSION}" ]]; then
            echo "Unable to derive version from tag: ${GITHUB_REF_NAME}"
            exit 1
          fi

          node scripts/version-check.mjs "$VERSION"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Validate AI API key env
        shell: bash
        run: |
          set -euo pipefail
          if [[ -z "${VITE_DEEPINFRA_API_KEY:-}" ]]; then
            echo "Missing VITE_DEEPINFRA_API_KEY (or DEEPINFRA_API_KEY) repository secret."
            exit 1
          fi

      - name: Build app
        shell: bash
        run: |
          set -euo pipefail
          pnpm tauri build --config src-tauri/tauri.production.conf.json --target x86_64-pc-windows-msvc --no-bundle

      - name: Upload release assets (Windows)
        shell: bash
        run: |
          set -euo pipefail
          EXE_FILE="src-tauri/target/x86_64-pc-windows-msvc/release/filearchitect-app.exe"
          gh release upload "${GITHUB_REF_NAME}" "$EXE_FILE" --clobber

  publish-release:
    name: Publish GitHub release
    if: >-
      ${{
        always() &&
        startsWith(github.ref, 'refs/tags/v') &&
        needs.create-release.result == 'success' &&
        (needs.build-macos.result == 'success' || needs.build-macos.result == 'skipped') &&
        (needs.build-macos-manifest.result == 'success' || needs.build-macos-manifest.result == 'skipped') &&
        (needs.build-windows.result == 'success' || needs.build-windows.result == 'skipped')
      }}
    needs:
      - create-release
      - build-macos
      - build-macos-manifest
      - build-windows
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Publish release
        shell: bash
        run: |
          set -euo pipefail
          gh release edit "${GITHUB_REF_NAME}" --repo "${GITHUB_REPOSITORY}" --draft=false
